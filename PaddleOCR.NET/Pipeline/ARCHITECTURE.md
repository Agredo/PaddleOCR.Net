# Complete OCR Pipeline - Architecture & Flow

## System Architecture

```
???????????????????????????????????????????????????????????????????????????
?                         PaddleOCR.NET Library                           ?
???????????????????????????????????????????????????????????????????????????
?                                                                         ?
?  ??????????????????????? OCRPipeline ???????????????????????          ?
?  ?                                                           ?          ?
?  ?  INPUT: byte[] imageData                                ?          ?
?  ?     ?                                                    ?          ?
?  ?     ?                                                    ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?  ? 1. DetectionModelV5                 ?               ?          ?
?  ?  ?    - Load image                     ?               ?          ?
?  ?  ?    - Resize & normalize             ?               ?          ?
?  ?  ?    - Run ONNX inference             ?               ?          ?
?  ?  ?    - Extract bounding boxes         ?               ?          ?
?  ?  ?    - Optional: Merge nearby boxes   ?               ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?     ?                                                    ?          ?
?  ?     ? DetectionResult (List<BoundingBox>)              ?          ?
?  ?     ?                                                    ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?  ? 2. ImageCropper                     ?               ?          ?
?  ?  ?    - Load original image            ?               ?          ?
?  ?  ?    - Crop each bounding box region  ?               ?          ?
?  ?  ?    - Return array of cropped images ?               ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?     ?                                                    ?          ?
?  ?     ? SKBitmap[] croppedRegions                        ?          ?
?  ?     ?                                                    ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?  ? 3. RecognitionModelV5 (Batch)      ?               ?          ?
?  ?  ?    - Resize to 48x320               ?               ?          ?
?  ?  ?    - Normalize pixels               ?               ?          ?
?  ?  ?    - Run ONNX inference (batched)   ?               ?          ?
?  ?  ?    - CTC decode predictions         ?               ?          ?
?  ?  ?    - Calculate confidences          ?               ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?     ?                                                    ?          ?
?  ?     ? RecognitionResult (List<RecognizedText>)         ?          ?
?  ?     ?                                                    ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?  ? 4. Combine Results                  ?               ?          ?
?  ?  ?    - Pair boxes with recognized text?               ?          ?
?  ?  ?    - Create OCRTextRegion objects   ?               ?          ?
?  ?  ???????????????????????????????????????               ?          ?
?  ?     ?                                                    ?          ?
?  ?     ?                                                    ?          ?
?  ?  OUTPUT: OCRResult                                      ?          ?
?  ?     - TextRegions (box + text + confidence)            ?          ?
?  ?     - DetectionResult (original boxes)                 ?          ?
?  ?     - GetFullText() method                             ?          ?
?  ????????????????????????????????????????????????????????????          ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
```

## Data Flow Example

```
Input Image (document.jpg)
  ?
  ? 1920x1080 pixels
  ?
???????????????????????????????????
?   DetectionModelV5              ?
?                                 ?
?   Step 1: Resize to 960px      ?
?   Step 2: Pad to 960x544       ?
?   Step 3: Normalize RGB         ?
?   Step 4: ONNX inference        ?
?   Step 5: Extract boxes         ?
???????????????????????????????????
  ?
  ? DetectionResult {
  ?   Boxes: [
  ?     Box1: [(10,20), (100,20), (100,40), (10,40)], conf=0.95
  ?     Box2: [(10,50), (150,50), (150,70), (10,70)], conf=0.92
  ?     Box3: [(10,80), (120,80), (120,100), (10,100)], conf=0.88
  ?   ]
  ? }
  ?
???????????????????????????????????
?   ImageCropper                  ?
?                                 ?
?   Crop Box1 ? bitmap1 (90x20)  ?
?   Crop Box2 ? bitmap2 (140x20) ?
?   Crop Box3 ? bitmap3 (110x20) ?
???????????????????????????????????
  ?
  ? SKBitmap[] = [bitmap1, bitmap2, bitmap3]
  ?
???????????????????????????????????
?   RecognitionModelV5            ?
?                                 ?
?   Process batch of 3 images:    ?
?   - Resize each to height=48    ?
?   - Pad to width=320            ?
?   - Normalize: (px/255-0.5)/0.5 ?
?   - ONNX inference (batched)    ?
?   - CTC decode each sequence    ?
???????????????????????????????????
  ?
  ? RecognitionResult {
  ?   Texts: [
  ?     "Hello World", conf=0.96
  ?     "PaddleOCR.NET", conf=0.94
  ?     "Test Image", conf=0.91
  ?   ]
  ? }
  ?
???????????????????????????????????
?   Combine Results               ?
?                                 ?
?   Region 0: Box1 + "Hello World"?
?   Region 1: Box2 + "PaddleOCR..." ?
?   Region 2: Box3 + "Test Image" ?
???????????????????????????????????
  ?
  ?
OCRResult {
  Count: 3
  TextRegions: [
    { Text: "Hello World", Confidence: 0.96, BoundingBox: Box1 }
    { Text: "PaddleOCR.NET", Confidence: 0.94, BoundingBox: Box2 }
    { Text: "Test Image", Confidence: 0.91, BoundingBox: Box3 }
  ]
}
```

## Component Interaction Diagram

```
??????????????????
?  Your App      ?
??????????????????
         ? new OCRPipelineBuilder()
         ?   .WithDetection(...)
         ?   .WithRecognition(...)
         ?   .Build()
         ?
??????????????????????????????????
?  OCRPipelineBuilder            ?
?                                ?
?  Creates:                      ?
?  ?? DetectionModelV5           ?
?  ?? RecognitionModelV5         ?
??????????????????????????????????
         ? Returns: OCRPipeline
         ?
??????????????????????????????????
?  OCRPipeline                   ?
?                                ?
?  Owns:                         ?
?  ?? IDetectionModel            ?
?  ?? IRecognitionModel          ?
??????????????????????????????????
         ? Process(imageBytes)
         ?
         ???????????????????????????????????????
         ?                                     ?
         ?                                     ?
????????????????????               ????????????????????
? DetectionModelV5 ?               ?ImageProcessing   ?
?                  ?               ?                  ?
? Uses:            ?               ? - ImageLoader    ?
? - ImageResizer   ?               ? - ImageCropper   ?
? - ImageNormalizer????????????????? - ImageExporter  ?
? - PostProcessor  ?               ?                  ?
????????????????????               ????????????????????
         ?
         ? Returns: DetectionResult
         ?
         ?
???????????????????????????????????
?  DetectionResult                ?
?  {                              ?
?    Boxes: List<BoundingBox>     ?
?    OriginalImageSize            ?
?    ProcessedImageSize           ?
?  }                              ?
???????????????????????????????????
         ?
         ? Crop regions
         ?
????????????????????
? ImageCropper     ?
?  CropRegions()   ?
????????????????????
         ? Returns: SKBitmap[]
         ?
???????????????????????????????????
? RecognitionModelV5              ?
?                                 ?
? Uses:                           ?
? - RecognitionPreProcessor       ?
? - RecognitionPostProcessor      ?
?   (CTC Decoding)                ?
???????????????????????????????????
         ? Returns: RecognitionResult
         ?
         ?
???????????????????????????????????
?  RecognitionResult              ?
?  {                              ?
?    Texts: List<RecognizedText>  ?
?      Text: string               ?
?      Confidence: float          ?
?      CharConfidences: float[]   ?
?  }                              ?
???????????????????????????????????
         ?
         ? Combine
         ?
???????????????????????????????????
?  OCRResult                      ?
?  {                              ?
?    TextRegions: [               ?
?      {                          ?
?        BoundingBox              ?
?        RecognizedText           ?
?        Index                    ?
?      }                          ?
?    ]                            ?
?    DetectionResult              ?
?  }                              ?
???????????????????????????????????
         ?
         ?
??????????????????
?  Your App      ?
?  Process       ?
?  Results       ?
??????????????????
```

## File Organization

```
PaddleOCR.NET/
?
??? Models/
?   ??? Detection/
?   ?   ??? IDetectionModel.cs
?   ?   ??? DetectionResult.cs
?   ?   ??? BoundingBox.cs
?   ?   ??? V5/
?   ?       ??? DetectionModelV5.cs
?   ?       ??? DetectionModelV5Builder.cs
?   ?       ??? README.md
?   ?
?   ??? Recognition/
?       ??? IRecognitionModel.cs
?       ??? RecognitionResult.cs
?       ??? RecognizedText.cs
?       ??? V5/
?           ??? RecognitionModelV5.cs
?           ??? RecognitionModelV5Builder.cs
?           ??? RecognitionPreProcessor.cs
?           ??? README.md
?
??? Pipeline/
?   ??? OCRPipeline.cs                ? Main orchestrator
?   ??? OCRPipelineBuilder.cs         ? Fluent builder
?   ??? OCRResult.cs                  ? Combined result
?   ??? README.md
?
??? ImageProcessing/
?   ??? ImageLoader.cs                ? Load images
?   ??? ImageCropper.cs               ? Crop regions ? NEW
?   ??? ImageResizer.cs               ? Resize logic
?   ??? ImageNormalizer.cs            ? Normalize pixels
?   ??? ImageExporter.cs              ? Export with boxes
?
??? Tensor/
?   ??? DetectionPostProcessor.cs     ? Extract boxes
?   ??? RecognitionPostProcessor.cs   ? CTC decoding
?
??? Examples/
?   ??? DetectionExample.cs
?   ??? RecognitionExample.cs
?   ??? OCRPipelineExample.cs         ? Complete examples ? NEW
?
??? QUICKSTART.md                     ? This file! ? NEW
```

## Processing Timeline

```
Time ?  0ms     100ms    200ms    300ms    400ms    500ms
        ?       ?        ?        ?        ?        ?
Image   ?       ?        ?        ?        ?        ?
Load    ???     ?        ?        ?        ?        ?
        ?       ?        ?        ?        ?        ?
Detection       ????????????      ?        ?        ?
                ?        ?        ?        ?        ?
Crop            ?        ?        ??       ?        ?
                ?        ?        ?        ?        ?
Recognition     ?        ?        ?        ????????????
                ?        ?        ?        ?        ?
Combine         ?        ?        ?        ?        ??
                ?        ?        ?        ?        ?
                ?        ?        ?        ?        ?
Total: ~500ms for typical document
```

## Memory Usage Flow

```
Stage              Memory Usage    Notes
?????????????????????????????????????????????????????????
1. Load Image      10-50 MB        Original image
2. Detection       50-100 MB       + Model + Tensor
3. Crop Regions    1-5 MB          Small bitmaps
4. Recognition     50-100 MB       + Model + Batch tensor
5. Final Result    < 1 MB          Text data only
?????????????????????????????????????????????????????????
Peak Memory:       ~150-200 MB     Both models loaded
```

## Key Design Decisions

### 1. Batch Processing in Recognition
```
Why: Recognition model processes multiple text regions efficiently
How: ImageCropper extracts all regions ? RecognitionModel processes batch
Benefit: 3-5x faster than processing regions individually
```

### 2. Separate Detection/Recognition
```
Why: Models have different purposes and can be configured independently
How: Pipeline composition pattern with builders
Benefit: Flexibility to swap models or adjust settings per use case
```

### 3. SKBitmap for Internal Processing
```
Why: SkiaSharp provides cross-platform image handling
How: Load ? Process ? Export, dispose bitmaps properly
Benefit: Works on Windows, Linux, macOS
```

### 4. Fluent Builder Pattern
```
Why: Easy configuration with sensible defaults
How: OCRPipelineBuilder with chained methods
Benefit: Clear, readable code with type safety
```

## Optimization Opportunities

### Current Implementation
- ? Batch recognition processing
- ? Efficient memory disposal
- ? Configurable batch sizes
- ? Optional box merging

### Future Enhancements
- ?? Parallel detection of multiple images
- ?? GPU acceleration via DirectML
- ?? Streaming API for large documents
- ?? Caching of preprocessed images
